<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test de fluidité</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-text-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.1.1"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet">
</head>
<body></body>

<script>
  // ✅ 初始化 jsPsych
  const jsPsych = initJsPsych({
    on_finish: function() {
      const json_data = jsPsych.data.get().json();
      fetch("https://script.google.com/macros/s/VOTRE_URL_GOOGLE_SCRIPT/exec", {
        method: "POST",
        body: json_data,
        headers: { "Content-Type": "application/json" }
      })
      .then(() => alert("Merci ! Vos réponses ont été envoyées avec succès."))
      .catch(() => alert("Erreur : l'envoi a échoué. Veuillez contacter le chercheur."));
    }
  });

  const timeline = [];

  // 👤 使用字符串标识符代替变量
  timeline.push({
    type: 'survey-html-form', // 直接使用插件注册名
    preamble: "<h2>Informations sur le participant</h2><p>Merci de répondre aux questions ci-dessous.</p>",
    html: `
      <label>Âge : <input name="age" type="number" required></label><br><br>
      <label>Genre :
        <select name="genre" required>
          <option value="">--Choisir--</option>
          <option value="Homme">Homme</option>
          <option value="Femme">Femme</option>
          <option value="Non-binaire">Non-binaire</option>
          <option value="Préférer ne pas dire">Préférer ne pas dire</option>
        </select>
      </label><br><br>
      <label>Profession : <input name="profession" type="text" required></label><br><br>
      <label>Langue maternelle : <input name="langue_maternelle" type="text" required></label><br><br>
      <label>Langues étrangères parlées : <input name="langues" type="text"></label><br><br>
      <label>Avez-vous appris le chinois ?
        <select name="chinois" required>
          <option value="">--Choisir--</option>
          <option value="Oui">Oui</option>
          <option value="Non">Non</option>
        </select>
      </label><br><br>
      <label>Utilisez-vous un appareil auditif ?
        <select name="appareil" required>
          <option value="">--Choisir--</option>
          <option value="Oui">Oui</option>
          <option value="Non">Non</option>
        </select>
      </label>
    `,
    button_label: "Commencer l'expérience"
  });

  // 📖 Consignes
  timeline.push({
    type: 'html-keyboard-response',
    stimulus: `
      <h1>Jugement de fluidité</h1>
      <h2>Consignes</h2>
      <p>
      Vous allez écouter 12 extraits audio de personnes lisant un court texte en français.<br><br>
      <strong>Votre tâche :</strong> Évaluer <strong>UNIQUEMENT</strong> la fluidité de chaque lecture sur une échelle de 1 à 10.<br><br>
      La fluidité se définit par :<br>
      ⏱️ Le débit : Rythme régulier<br>
      ⏸️ Les pauses : Aux endroits logiques, sans hésitations fréquentes<br>
      🎶 Le flux : Liaisons naturelles, intonation cohérente<br><br>
      Ignorez :<br>
      ❌ L'accent<br>
      ❌ La prononciation<br>
      ❌ Votre opinion sur le texte<br><br>
      Appuyez sur une touche pour commencer.
      </p>
    `
  });

  // 🎵 动态获取基础路径
  const base_path = window.location.href.replace(/\/[^\/]*$/, '') + '/';
  
  // ✅ 音频文件列表
  let audio_files = [
    `${base_path}audio/1.wav`,
    `${base_path}audio/2.wav`,
    `${base_path}audio/3.wav`,
    `${base_path}audio/4.wav`,
    `${base_path}audio/5.wav`,
    `${base_path}audio/6.wav`,
    `${base_path}audio/7.wav`,
    `${base_path}audio/8.wav`,
    `${base_path}audio/9.wav`,
    `${base_path}audio/10.wav`,
    `${base_path}audio/11.wav`,
    `${base_path}audio/12.wav`
  ];

  // 调试：检查文件路径
  console.log("Audio files paths:", audio_files);

  audio_files = jsPsych.randomization.shuffle(audio_files);

  audio_files.forEach(file => {
    timeline.push(
      {
        type: 'audio-keyboard-response',
        stimulus: file,
        choices: "NO_KEYS",
        trial_ends_after_audio: true
      },
      {
        type: 'html-slider-response',
        stimulus: '<p>Sur une échelle de 1 à 10, comment jugez-vous la fluidité de cet extrait ?</p>',
        min: 1,
        max: 10,
        step: 1,
        slider_start: 5,
        labels: ['1 (Pas fluide)', '10 (Très fluide)'],
        require_movement: true,
        data: { question: 'fluidity_rating', audio: file }
      },
      {
        type: 'html-text-response',
        stimulus: '<p>Pourquoi avez-vous choisi ce chiffre ?</p>',
        placeholder: 'Votre réponse ici...',
        rows: 3,
        columns: 60,
        data: { question: 'justification', audio: file }
      }
    );
  });

  // 🎉 Fin de l'expérience
  timeline.push({
    type: 'html-keyboard-response',
    stimulus: '<p>Merci pour votre participation !<br>Appuyez sur une touche pour envoyer vos réponses.</p>'
  });

  // 🚀 Lancer l'expérience
  jsPsych.run(timeline);
</script>
</html>
