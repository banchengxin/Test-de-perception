<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test d'√©valuation de fluidit√©</title>
  <link href="dist/jspsych.css" rel="stylesheet" />
  <script src="dist/jspsych.js"></script>
  <script src="dist/plugin-html-button-response.js"></script>
  <script src="dist/plugin-survey-text.js"></script>
  <script src="dist/plugin-survey-multi-choice.js"></script>
</head>
<body></body>

<script>
const jsPsych = initJsPsych({
  on_finish: () => {
    const rawData = jsPsych.data.get().values();

    // Ê∏ÖÊ¥óÊï∞ÊçÆÁªìÊûÑ
    const cleanedData = rawData.map(d => ({
      age: d.response?.age || '',
      gender: d.response?.gender || '',
      profession: d.response?.profession || '',
      native_language: d.response?.native_language || '',
      other_languages: d.response?.other_languages || '',
      speaks_chinese: d.response?.speaks_chinese || '',
      file: d.file || '',
      trial_num: d.trial_num || '',
      phase: d.phase || '',
      rating: d.button_pressed ? parseInt(d.button_pressed) + 1 : '',
      explanation: d.response?.explanation || ''
    }));

    // üîÅ ÊõøÊç¢Êàê‰Ω†ÁöÑ Google Apps Script ÈÉ®ÁΩ≤ÈìæÊé•
    fetch('https://script.google.com/macros/s/AKfycbx3dm_-c7IQ7_8I50dPFLouXsBFr7x74jlGXgElPsDoD55CWMP3hM3l5k-usS9nIhKR/exec', {
      method: 'POST',
      body: JSON.stringify(cleanedData),
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(() => {
      jsPsych.data.displayData(); // ‰Ω†‰πüÂèØ‰ª•ÈÄâÊã©‰∏çÊòæÁ§∫
    }).catch(error => {
      console.error('Erreur d‚Äôenvoi vers Google Sheets:', error);
      alert('Erreur de sauvegarde. Veuillez r√©essayer plus tard.');
    });
  }
});


  const timeline = [];

  const MAX_PLAYS = 3;

  // Participant demographics survey
timeline.push({
  type: jsPsychSurveyText,
  preamble: "<h3>Avant de commencer, merci de r√©pondre aux questions suivantes :</h3>",
  questions: [
    {
      prompt: "√Çge :",
      name: "age",
      required: true
    },
    {
      prompt: "Profession :",
      name: "profession",
      required: true
    },
    {
      prompt: "Langue maternelle :",
      name: "native_language",
      required: true
    },
    {
      prompt: "Quelles langues parlez-vous ? (s√©par√©es par des virgules)",
      name: "other_languages",
      required: false
    }
  ],
  data: {
    phase: "demographics_text"
  }
});

timeline.push({
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: "Genre :",
      name: "gender",
      options: ["Homme", "Femme", "Non binaire", "Pr√©f√©rer ne pas dire", "Autre"],
      required: true
    },
    {
      prompt: "Parlez-vous chinois ?",
      name: "speaks_chinese",
      options: ["Oui", "Non", "Un peu"],
      required: true
    }
  ],
  data: {
    phase: "demographics_choice"
  }
});


  // Instructions en fran√ßais
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>Consignes</h2>
      <p>Vous allez √©couter <strong>12 extraits audio</strong> de personnes lisant un court texte en fran√ßais.</p>
      <p><strong>Votre t√¢che</strong> : √âvaluer <u>UNIQUEMENT</u> la fluidit√© de chaque lecture sur une √©chelle de 1 √† 10.</p>
      <h3>La fluidit√© se d√©finit par :</h3>
      <ul style="text-align:left; max-width: 600px; margin:auto;">
        <li>‚è±Ô∏è <strong>Le d√©bit</strong> : Rythme r√©gulier</li>
        <li>‚è∏Ô∏è <strong>Les pauses</strong> : Aux endroits logiques (virgules, points), sans h√©sitations fr√©quentes ("euh...")</li>
        <li>üé∂ <strong>Le flux</strong> : Liaisons naturelles entre les mots, intonation coh√©rente</li>
      </ul>
      <h3>Ignorez :</h3>
      <ul style="text-align:left; max-width: 600px; margin:auto;">
        <li>‚ùå L'accent ou la prononciation des sons individuels</li>
        <li>‚ùå La complexit√© du vocabulaire</li>
        <li>‚ùå Votre opinion sur le contenu du texte</li>
      </ul>
      <p><strong>Cliquez sur "Commencer" pour lancer l‚Äô√©valuation.</strong></p>
    `,
    choices: ['Commencer']
  });

  // G√©n√®re les essais audio + √©valuation + explication
  const generateAudioTrials = () => {
    const prompt_rating = `<p>√âvaluez la fluidit√© de cette lecture (1 = pas fluide, 10 = tr√®s fluide)</p>`;
    const prompt_explanation = `<p>Pourquoi?</p>`;

    const audio_files = jsPsych.randomization.shuffle(
      Array.from({length: 12}, (_, i) => `audio/${i + 1}.wav`)
    );

    return audio_files.map((file, index) => {
      const ratingTrial = {
        type: jsPsychHtmlButtonResponse,
        stimulus: () => `
          <p>Cliquez sur "Jouer" pour √©couter. Vous pouvez jouer jusqu‚Äô√† ${MAX_PLAYS} fois.</p>
          <audio id="audio_stimulus" src="${file}"></audio>
          <button id="play_button" type="button">Jouer</button>
        `,
        choices: ['1','2','3','4','5','6','7','8','9','10'],
        prompt: prompt_rating,
        data: {
          file: file,
          trial_num: index + 1,
          phase: 'rating'
        },
        on_load: () => {
          let playCount = 0;
          const audio = document.getElementById('audio_stimulus');
          const playButton = document.getElementById('play_button');
          playButton.addEventListener('click', () => {
            if(playCount < MAX_PLAYS) {
              audio.currentTime = 0;
              audio.play();
              playCount++;
              if(playCount >= MAX_PLAYS) {
                playButton.disabled = true;
                playButton.textContent = 'Limite atteinte';
              }
            }
          });
        }
      };

      const explanationTrial = {
        type: jsPsychSurveyText,
        questions: [
          {
            prompt: prompt_explanation,
            rows: 3,
            columns: 50,
            name: 'explanation'
          }
        ],
        data: {
          file: file,
          trial_num: index + 1,
          phase: 'explanation'
        }
      };

      return [ratingTrial, explanationTrial];
    }).flat();
  };

  timeline.push(...generateAudioTrials());

  // Fin et remerciements
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p>Merci pour votre participation !</p>',
    choices: ['Voir les r√©sultats']
  });

  jsPsych.run(timeline);

</script>

</html>
