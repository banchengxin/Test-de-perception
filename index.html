<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test d'√©valuation de fluidit√©</title>
  <link href="dist/jspsych.css" rel="stylesheet" />
  <script src="dist/jspsych.js"></script>
  <script src="dist/plugin-html-button-response.js"></script>
  <script src="dist/plugin-survey-text.js"></script>
  <script src="dist/plugin-survey-multi-choice.js"></script>
  <script src="dist/plugin-survey-html-form.js"></script>
</head>
<body></body>

<script>
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData()
  });

  const timeline = [];

  const MAX_PLAYS = 3;

  // Instructions g√©n√©rales
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>Bienvenue au test d'√©valuation de fluidit√©</h2>
      <p>Avant de commencer, nous avons besoin de quelques informations sur vous.</p>
      <p>Ensuite, vous √©couterez <strong>12 extraits audio</strong> de personnes lisant un court texte en fran√ßais.</p>
      <p><strong>Cliquez sur "Continuer" pour commencer.</strong></p>
    `,
    choices: ['Continuer']
  });

  // Questionnaire d√©mographique
  timeline.push({
    type: jsPsychSurveyHtmlForm,
    html: `
      <h2>Informations personnelles</h2>
      <div style="text-align: left; max-width: 600px; margin: auto;">
        <p><label for="age">√Çge :</label><br>
        <input type="number" id="age" name="age" min="18" max="99" required style="width: 100px;"></p>
        
        <p><label for="gender">Genre :</label><br>
        <select id="gender" name="gender" required style="width: 200px;">
          <option value="">S√©lectionnez...</option>
          <option value="femme">Femme</option>
          <option value="homme">Homme</option>
          <option value="autre">Autre</option>
          <option value="non-binaire">Non-binaire</option>
          <option value="prefere_ne_pas_dire">Pr√©f√®re ne pas dire</option>
        </select></p>
        
        <p><label for="profession">Profession/Domaine d'activit√© :</label><br>
        <input type="text" id="profession" name="profession" required style="width: 300px;"></p>
        
        <p><label for="education">Niveau d'√©ducation :</label><br>
        <select id="education" name="education" required style="width: 300px;">
          <option value="">S√©lectionnez...</option>
          <option value="primaire">Primaire</option>
          <option value="secondaire">Secondaire</option>
          <option value="bac">Baccalaur√©at</option>
          <option value="bac_plus_2">Bac+2 (BTS, DUT, etc.)</option>
          <option value="licence">Licence (Bac+3)</option>
          <option value="master">Master (Bac+5)</option>
          <option value="doctorat">Doctorat</option>
          <option value="autre">Autre</option>
        </select></p>
        
        <p><label for="native_language">Langue maternelle :</label><br>
        <input type="text" id="native_language" name="native_language" required style="width: 200px;"></p>
        
        <p><label for="chinese_speaker">Parlez-vous chinois ?</label><br>
        <select id="chinese_speaker" name="chinese_speaker" required style="width: 200px;">
          <option value="">S√©lectionnez...</option>
          <option value="oui_courant">Oui, couramment</option>
          <option value="oui_intermediaire">Oui, niveau interm√©diaire</option>
          <option value="oui_debutant">Oui, niveau d√©butant</option>
          <option value="non">Non</option>
        </select></p>
        
        <p><label for="french_level">Niveau de fran√ßais :</label><br>
        <select id="french_level" name="french_level" required style="width: 200px;">
          <option value="">S√©lectionnez...</option>
          <option value="natif">Natif</option>
          <option value="c2">C2 (Ma√Ætrise)</option>
          <option value="c1">C1 (Autonome)</option>
          <option value="b2">B2 (Avanc√©)</option>
          <option value="b1">B1 (Interm√©diaire)</option>
          <option value="a2">A2 (√âl√©mentaire)</option>
          <option value="a1">A1 (D√©butant)</option>
        </select></p>
        
        <p><label for="other_languages">Autres langues parl√©es (s√©par√©es par des virgules) :</label><br>
        <input type="text" id="other_languages" name="other_languages" style="width: 400px;" placeholder="ex: anglais, espagnol, allemand"></p>
        
        <p><label for="listening_experience">Avez-vous de l'exp√©rience dans l'√©valuation de la parole ou de la prononciation ?</label><br>
        <select id="listening_experience" name="listening_experience" required style="width: 300px;">
          <option value="">S√©lectionnez...</option>
          <option value="oui_professionnel">Oui, professionnel (enseignant, linguiste, etc.)</option>
          <option value="oui_formation">Oui, j'ai re√ßu une formation</option>
          <option value="oui_occasionnel">Oui, de mani√®re occasionnelle</option>
          <option value="non">Non</option>
        </select></p>
        
        <p><label for="hearing_problems">Avez-vous des probl√®mes d'audition ?</label><br>
        <select id="hearing_problems" name="hearing_problems" required style="width: 200px;">
          <option value="">S√©lectionnez...</option>
          <option value="non">Non</option>
          <option value="oui_leger">Oui, l√©ger</option>
          <option value="oui_modere">Oui, mod√©r√©</option>
          <option value="oui_severe">Oui, s√©v√®re</option>
        </select></p>
      </div>
    `,
    data: {
      phase: 'demographics'
    }
  });

  // Instructions pour l'√©valuation
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>Consignes pour l'√©valuation</h2>
      <p>Vous allez maintenant √©couter <strong>12 extraits audio</strong> de personnes lisant un court texte en fran√ßais.</p>
      <p><strong>Votre t√¢che</strong> : √âvaluer <u>UNIQUEMENT</u> la fluidit√© de chaque lecture sur une √©chelle de 1 √† 10.</p>
      <h3>La fluidit√© se d√©finit par :</h3>
      <ul style="text-align:left; max-width: 600px; margin:auto;">
        <li>‚è±Ô∏è <strong>Le d√©bit</strong> : Rythme r√©gulier</li>
        <li>‚è∏Ô∏è <strong>Les pauses</strong> : Aux endroits logiques (virgules, points), sans h√©sitations fr√©quentes ("euh...")</li>
        <li>üé∂ <strong>Le flux</strong> : Liaisons naturelles entre les mots, intonation coh√©rente</li>
      </ul>
      <h3>Ignorez :</h3>
      <ul style="text-align:left; max-width: 600px; margin:auto;">
        <li>‚ùå L'accent ou la prononciation des sons individuels</li>
        <li>‚ùå La complexit√© du vocabulaire</li>
        <li>‚ùå Votre opinion sur le contenu du texte</li>
      </ul>
      <p><strong>Cliquez sur "Commencer l'√©valuation" pour lancer l'√©valuation.</strong></p>
    `,
    choices: ['Commencer l\'√©valuation']
  });

  // G√©n√®re les essais audio + √©valuation + explication (r√©duit √† 12)
  const generateAudioTrials = () => {
    const prompt_rating = `<p>√âvaluez la fluidit√© de cette lecture (1 = pas fluide, 10 = tr√®s fluide)</p>`;
    const prompt_explanation = `<p>Pourquoi avez-vous choisi ce chiffre ?</p>`;

    const audio_files = jsPsych.randomization.shuffle(
      Array.from({length: 12}, (_, i) => `audio/${i + 1}.wav`)
    );

    return audio_files.map((file, index) => {
      const ratingTrial = {
        type: jsPsychHtmlButtonResponse,
        stimulus: () => `
          <p><strong>Extrait ${index + 1}/12</strong></p>
          <p>Cliquez sur "Jouer" pour √©couter. Vous pouvez jouer jusqu'√† ${MAX_PLAYS} fois.</p>
          <audio id="audio_stimulus" src="${file}"></audio>
          <button id="play_button" type="button">Jouer</button>
        `,
        choices: ['1','2','3','4','5','6','7','8','9','10'],
        prompt: prompt_rating,
        data: {
          file: file,
          trial_num: index + 1,
          phase: 'rating'
        },
        on_load: () => {
          let playCount = 0;
          const audio = document.getElementById('audio_stimulus');
          const playButton = document.getElementById('play_button');
          playButton.addEventListener('click', () => {
            if(playCount < MAX_PLAYS) {
              audio.currentTime = 0;
              audio.play();
              playCount++;
              if(playCount >= MAX_PLAYS) {
                playButton.disabled = true;
                playButton.textContent = 'Limite atteinte';
              }
            }
          });
        }
      };

      const explanationTrial = {
        type: jsPsychSurveyText,
        questions: [
          {
            prompt: prompt_explanation,
            rows: 3,
            columns: 50,
            name: 'explanation'
          }
        ],
        data: {
          file: file,
          trial_num: index + 1,
          phase: 'explanation'
        }
      };

      return [ratingTrial, explanationTrial];
    }).flat();
  };

  timeline.push(...generateAudioTrials());

  // Fin et remerciements
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p>Merci pour votre participation !</p>',
    choices: ['Voir les r√©sultats']
  });

  jsPsych.run(timeline);

</script>

</html>
